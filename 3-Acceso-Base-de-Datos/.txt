ðŸŸ¢ðŸŸ¡ðŸ”´

Acceso a Base de Datos con Express y PG 


Aprenderemos a crear un servidor al estilo Rest con
ExpressJS que lea y guarde los datos de un pedido en una
base de datos SQL.

ðŸŸ¢ OBJETIVOS
  Insertar datos en una tabla alojada en PostgreSQL usando el
  paquete pg.
  Mostrar por consola datos alojados en PostgreSQL usando el
  paquete pg.
  Crear una ruta GET con Express para devolver los registros de una
  tabla alojada en PostgreSQL.
  Crear una ruta POST con Express que reciba y almacene en
  PostgreSQL un nuevo registro.

ðŸŸ¢ Express y bases de datos
  Con Node y Express podemos crear aplicaciones que pidan o guarden datos en distintos motores de bases de datos.
  En esta unidad aprenderemos a hacerlo con postgreSQL.

ðŸŸ¢ El paquete pg https://node-postgres.com/
  El paquete pg nos permite conectarnos e interactuar con una base de datos
  PostgreSQL y estÃ¡ disponible en NPM.

  ðŸŸ¡ InstalaciÃ³n del paquete pg
  
  ðŸŸ¡ Primera consulta SQL con Node
    Para empezar a hacer consultas SQL desde Node, crearemos una base de datos que tenga como
    objetivo almacenar los PRODUCTOS.
    Abre la terminal psql y escribe las siguientes instrucciones para crear una base de datos TIENDA
    y una tabla PRODUCTOS:

    CREATE DATABASE tienda;
    \c tienda;
    CREATE TABLE productos(id: serial, nombre: varchar, precio: int, stoc: int not null)
  
  ðŸŸ¡ Acceso a base datos con Node
      Crear un archivo consultas.js 
      const { Pool } = require('pg')
      
      const pool = new Pool({
      host: 'localhost',
      user: 'postgres',
      password: 'postgres',
      database: '',
      allowExitOnIdle: true
      })

      const getDate = async () => {
      const result = await pool.query("SELECT NOW()")
      console.log(result)
      }
      getDate()

      La clase Pool nos permite soportar
      multiconexiones y un mejor
      rendimiento en las consultas.

      Esta propiedad le indicarÃ¡ a
      PostgreSQL que cierre la
      conexiÃ³n luego de cada consulta

      Cada consulta devuelve un objeto
      result con el detalle obtenido en
      su ejecuciÃ³n.
  
  ðŸŸ¡ El objeto result

    El objeto result contiene entre varias propiedades:
    â— command: El comando SQL que se utilizÃ³ en la
    consulta.
    â— rowCount: Cantidad de filas que fueron procesadas
    en la consulta.
    â— rows: Un arreglo de objetos con todos los
    resultados o filas obtenido en la consulta.
    â— fields: La estructura de cada uno de los campos o
    columnas en las filas obtenidas.

   ðŸŸ¡ Primer registro en PostgreSQL desde Node

    const agregarProducto = async (nombre, precio, stock) => {
    const consulta = "INSERT INTO productos values (DEFAULT, $1, $2)"
    const values = [nombre, precio, stock]
    const result = await pool.query(consulta, values)
    console.log("Producto agregado")
    }

    En esta ocasiÃ³n estamos usando el mÃ©todo query()
    para hacer una consulta parametrizada que nos ayuda
    a evitar un problema llamado SQL Injection, el cual se
    discute en la guÃ­a de esta unidad.

    ðŸ”´ Â¿QuÃ© es un SQL Injection?
      La inyecciÃ³n de SQL es una tÃ©cnica que consiste en inyectar cÃ³digo SQL a partir de un input,
      este puede ser un formulario de una pÃ¡gina web o un valor que enviemos a una API REST
      desde un cliente. El cÃ³digo inyectado se ejecuta en el servidor y puede modificar accesos de
      usuarios, insertar registros o incluso borrar tablas.

ðŸŸ¢ Obteniendo registros de PostgreSQL desde Node

    ðŸŸ¡ Para obtener los registros almacenados en PostgreSQL crea una nueva funciÃ³n en el archivo consultas.js que muestre
    por consola y retorne las filas de la tabla viajes:
    Ejecutando esta funciÃ³n veremos por consola el viaje a Valdivia registrado anteriormente.
    const obtenerProductos = async () => {
    const { rows } = await pool.query("SELECT * FROM productos")
    console.log(rows)
    return rows
    }
    obtenerProductos()

ðŸŸ¢ API REST con PostgreSQL(GET)
  Ahora que podemos interactuar con una base de datos PostgreSQL para obtener y hacer registros, unamos los
  conocimientos previos para crear una API REST con Express que ofrezca una ruta GET /productos que devuelva todos los
  productos registrados en la tabla.

ðŸŸ¢ API REST con PostgreSQL(POST)